<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .badge { padding: 0.25em 0.8em; font-size: 0.75rem; font-weight: 700; border-radius: 0.5rem; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-graduation-cap text-2xl text-indigo-600"></i>
                    <h1 class="text-xl font-bold tracking-tight text-gray-900">Student<span class="text-indigo-600">Hub</span></h1>
                </div>
                <div class="text-sm text-gray-500 hidden sm:block" id="last-updated"></div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white shadow rounded-xl p-5 border-l-4 border-blue-500">
                <dt class="text-sm font-medium text-gray-500">Total Tasks</dt>
                <dd class="mt-1 text-3xl font-semibold text-gray-900" id="stat-total">0</dd>
            </div>
            <div class="bg-white shadow rounded-xl p-5 border-l-4 border-yellow-400">
                <dt class="text-sm font-medium text-gray-500">Upcoming (7 Days)</dt>
                <dd class="mt-1 text-3xl font-semibold text-gray-900" id="stat-upcoming">0</dd>
            </div>
            <div class="bg-white shadow rounded-xl p-5 border-l-4 border-red-500">
                <dt class="text-sm font-medium text-gray-500">Overdue</dt>
                <dd class="mt-1 text-3xl font-semibold text-gray-900" id="stat-overdue">0</dd>
            </div>
            <div class="bg-white shadow rounded-xl p-5 border-l-4 border-green-500">
                <dt class="text-sm font-medium text-gray-500">Completed</dt>
                <dd class="mt-1 text-3xl font-semibold text-gray-900" id="stat-completed">-</dd>
            </div>
        </div>

        <!-- Filters -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <div class="relative w-full sm:w-96">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fa-solid fa-search text-gray-400"></i>
                </div>
                <input type="text" id="search-input" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Search assignments...">
            </div>
            <select id="filter-class" class="block w-full sm:w-auto py-2 px-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none sm:text-sm">
                <option value="All">All Classes</option>
            </select>
        </div>

        <!-- Loader -->
        <div id="loader" class="text-center py-20">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-indigo-600"></div>
            <p class="mt-4 text-gray-500">Syncing with Google Sheets...</p>
        </div>

        <!-- Cards Container -->
        <div id="assignment-container" class="grid gap-4 hidden"></div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-20">
            <i class="fa-regular fa-clipboard text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900">No active assignments</h3>
            <p class="text-gray-500">You're all caught up!</p>
        </div>
    </main>

    <footer class="bg-white border-t border-gray-200 mt-12">
        <div class="max-w-6xl mx-auto px-4 py-6 text-center text-sm text-gray-500">
            &copy; 2025 StudentHub
        </div>
    </footer>

    <script>
        // ==========================================
        // ⚙️ CONFIGURATION
        // Paste your "Publish to Web" CSV link here:
        // ==========================================
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzkyidBhfigPvat3WEZFh6IhblU1GPSZIiPAeI27ALZ4yfoxzfHiji3HtczzYHTS-b3d3dj1iYmHSu/pub?gid=0&single=true&output=csv"; 

        let allAssignments = [];

        document.addEventListener('DOMContentLoaded', () => {
            if(SHEET_CSV_URL.includes("YOUR_GOOGLE_SHEET")) {
                alert("Don't forget to paste your CSV link in the code!");
                return;
            }
            fetchData();
            document.getElementById('search-input').addEventListener('input', filterData);
            document.getElementById('filter-class').addEventListener('change', filterData);
        });

        async function fetchData() {
            try {
                const response = await fetch(SHEET_CSV_URL);
                const data = await response.text();
                
                // We need to skip the top rows (Title, Charts)
                // In your image, the header "CLASS NAME" is on Row 4.
                // Data starts on Row 5.
                
                allAssignments = parseCSV(data);
                
                populateClassFilter();
                calculateStats();
                renderAssignments(allAssignments);
                
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('assignment-container').classList.remove('hidden');
                document.getElementById('last-updated').innerText = `Last synced: ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loader').innerHTML = `<p class="text-red-500">Error loading data. Check console.</p>`;
            }
        }

        function parseCSV(text) {
            // 1. Split into lines
            const lines = text.split(/\r\n|\n/);
            const result = [];

            // 2. Loop through lines
            // We start looking for data only AFTER we find the header "CLASS NAME"
            let foundHeader = false;

            for (let i = 0; i < lines.length; i++) {
                // Handle quotes properly using regex split
                // This regex splits by comma but ignores commas inside quotes
                const row = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cell => cell.replace(/^"|"$/g, '').trim());

                // Detect the Header Row (Row 4 in your sheet)
                if (!foundHeader) {
                    if (row.length > 1 && (row[1].toUpperCase().includes("CLASS NAME") || row[0].toUpperCase().includes("CLASS NAME"))) {
                        foundHeader = true;
                    }
                    continue; // Skip this row (it's title or header)
                }

                // 3. Mapping Columns (Based on your screenshot)
                // Column A [0]: Checkbox (Empty in CSV often)
                // Column B [1]: CLASS NAME
                // Column C [2]: ASSIGNMENT
                // Column D [3]: DESCRIPTION
                // Column E [4]: PRIORITY
                // Column F [5]: DATE
                // Column G [6]: DAYS LEFT
                
                const className = row[1]; // Column B
                const title = row[2];     // Column C
                
                // VALIDATION: Skip row if Class Name is empty (Fixes the ghost cards)
                if (!className || className === "") continue;

                const obj = {
                    className: className,
                    title: title || "Untitled Assignment",
                    desc: row[3] || "",
                    priority: row[4] || "Low",
                    date: row[5] || "",
                    daysLeft: parseInt(row[6]) || 0
                };

                result.push(obj);
            }
            return result;
        }

        function calculateStats() {
            const total = allAssignments.length;
            const upcoming = allAssignments.filter(a => a.daysLeft <= 7 && a.daysLeft >= 0).length;
            const overdue = allAssignments.filter(a => a.daysLeft < 0).length;
            
            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-upcoming').innerText = upcoming;
            document.getElementById('stat-overdue').innerText = overdue;
        }

        function populateClassFilter() {
            const classes = [...new Set(allAssignments.map(item => item.className))].sort();
            const select = document.getElementById('filter-class');
            classes.forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.innerText = c;
                select.appendChild(option);
            });
        }

        function filterData() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const classFilter = document.getElementById('filter-class').value;

            const filtered = allAssignments.filter(item => {
                const matchesSearch = (item.title.toLowerCase().includes(searchTerm) || 
                                     item.className.toLowerCase().includes(searchTerm));
                const matchesClass = classFilter === "All" || item.className === classFilter;
                return matchesSearch && matchesClass;
            });

            renderAssignments(filtered);
        }

        function renderAssignments(data) {
            const container = document.getElementById('assignment-container');
            container.innerHTML = '';

            if (data.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            } else {
                document.getElementById('empty-state').classList.add('hidden');
            }

            data.forEach(item => {
                // Priority Colors
                let priorityClass = "bg-gray-100 text-gray-800";
                if(item.priority.toLowerCase().includes("high")) priorityClass = "bg-red-100 text-red-800";
                if(item.priority.toLowerCase().includes("medium")) priorityClass = "bg-yellow-100 text-yellow-800";
                if(item.priority.toLowerCase().includes("low")) priorityClass = "bg-green-100 text-green-800";

                // Days Left Logic
                let daysColor = "text-gray-600";
                let daysText = `${item.daysLeft} Days Left`;
                if (item.daysLeft < 0) {
                    daysColor = "text-red-600 font-bold";
                    daysText = `Overdue by ${Math.abs(item.daysLeft)} Days`;
                } else if (item.daysLeft <= 3) {
                    daysColor = "text-orange-600 font-bold";
                }

                const card = document.createElement('div');
                card.className = "bg-white rounded-lg shadow hover:shadow-md transition duration-200 p-5 border border-gray-100 flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center fade-in";
                
                card.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                                ${item.className}
                            </span>
                            <span class="badge ${priorityClass}">
                                ${item.priority}
                            </span>
                        </div>
                        <h4 class="text-lg font-semibold text-gray-900">${item.title}</h4>
                        <p class="text-sm text-gray-500 mt-1 line-clamp-2">${item.desc}</p>
                    </div>
                    
                    <div class="flex items-center gap-6 w-full sm:w-auto justify-between sm:justify-end mt-2 sm:mt-0 border-t sm:border-t-0 pt-3 sm:pt-0">
                        <div class="text-right">
                            <p class="text-xs text-gray-400 uppercase font-semibold">Due Date</p>
                            <p class="font-medium text-gray-900">${item.date}</p>
                        </div>
                        <div class="text-right w-24">
                            <p class="text-xs ${daysColor} uppercase font-semibold">${daysText}</p>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
    </script>
</body>
</html>
