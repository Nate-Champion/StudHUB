<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeadlineTracker</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: "Poppins", sans-serif; }
        .badge { padding: 0.25em 0.8em; font-size: 0.75rem; font-weight: 700; border-radius: 0.5rem; }
        .fade-in { animation: fadeIn .4s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .completed { opacity: 0.7; }
        .completed-card { 
            order: 9999;
            background-color: rgba(243, 244, 246, 0.5) !important;
        }
        .dark .completed-card {
            background-color: rgba(31, 41, 55, 0.4) !important;
        }
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .custom-checkbox {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #d1d5db;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .dark .custom-checkbox {
            border-color: #4b5563;
        }
        .custom-checkbox.checked {
            background-color: #10b981;
            border-color: #10b981;
        }
        .custom-checkbox.checked::after {
            content: 'âœ“';
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition">

    <!-- HEADER -->
    <nav class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-50 transition">
        <div class="max-w-6xl mx-auto px-4 h-16 flex justify-between items-center">

            <div class="flex items-center gap-3">
                <i class="fa-solid fa-calendar-day text-2xl text-indigo-500"></i>
                <h1 class="text-xl font-bold">Deadline<span class="text-indigo-500">Tracker</span></h1>
            </div>

            <div class="flex items-center gap-4">
                <div id="last-updated" class="hidden sm:block text-sm text-gray-500 dark:text-gray-300"></div>

                <!-- THEME TOGGLE -->
                <button id="theme-toggle"
                    class="text-xl p-2 rounded-lg bg-gray-200 dark:bg-gray-700 transition">
                    <i id="theme-icon" class="fa-solid"></i>
                </button>
            </div>

        </div>
    </nav>

    <!-- MAIN -->
    <main class="max-w-6xl mx-auto px-4 py-8">

        <!-- STATS -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-white dark:bg-gray-800 shadow rounded-xl p-5 border-l-4 border-blue-500">
                <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Total Tasks</dt>
                <dd class="mt-1 text-3xl font-semibold text-gray-900 dark:text-white" id="stat-total">0</dd>
            </div>

            <div class="bg-white dark:bg-gray-800 shadow rounded-xl p-5 border-l-4 border-yellow-400">
                <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Upcoming (7 Days)</dt>
                <dd class="mt-1 text-3xl font-semibold text-gray-900 dark:text-white" id="stat-upcoming">0</dd>
            </div>
            
            <div class="bg-white dark:bg-gray-800 shadow rounded-xl p-5 border-l-4 border-green-500">
                <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Active</dt>
                <dd class="mt-1 text-3xl font-semibold text-gray-900 dark:text-white" id="stat-active">0</dd>
            </div>
            
            <div class="bg-white dark:bg-gray-800 shadow rounded-xl p-5 border-l-4 border-gray-400">
                <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Completed</dt>
                <dd class="mt-1 text-3xl font-semibold text-gray-900 dark:text-white" id="stat-completed">0</dd>
            </div>
        </div>

        <!-- FILTERS & CONTROLS -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">

            <!-- Search -->
            <div class="relative w-full sm:w-96">
                <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input id="search-input" placeholder="Search..."
                    class="w-full pl-10 pr-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700
                    bg-white dark:bg-gray-800 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <div class="flex items-center gap-3">
                <!-- Class Filter -->
                <select id="filter-class"
                    class="py-2 px-3 rounded-lg border border-gray-300 dark:border-gray-700
                    bg-white dark:bg-gray-800 dark:text-gray-100 shadow-sm">
                    <option value="All">All Classes</option>
                </select>
                
                <!-- Show/Hide Completed -->
                <button id="toggle-completed" class="py-2 px-3 rounded-lg border border-gray-300 dark:border-gray-700
                    bg-white dark:bg-gray-800 dark:text-gray-100 shadow-sm text-sm">
                    <i class="fa-regular fa-eye mr-1"></i> Show Completed
                </button>
            </div>

        </div>

        <!-- LOADER -->
        <div id="loader" class="text-center py-20">
            <div class="animate-spin h-12 w-12 border-t-4 border-b-4 border-indigo-600 rounded-full mx-auto"></div>
            <p class="mt-4 text-gray-500 dark:text-gray-400">Syncing with Google Sheets...</p>
        </div>

        <!-- CARDS -->
        <div id="assignment-container" class="grid gap-4 hidden"></div>

        <!-- EMPTY -->
        <div id="empty-state" class="hidden text-center py-20">
            <i class="fa-regular fa-clipboard text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium">No active assignments</h3>
            <p class="text-gray-500">You're all caught up!</p>
        </div>

    </main>

    <footer class="text-center py-6 text-sm text-gray-500 dark:text-gray-400 border-t border-gray-300 dark:border-gray-700">
        &copy; 2025 DeadlineTracker
    </footer>

    <!-- SCRIPT -->
    <script>
        const SHEET_CSV_URL =
            "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzkyidBhfigPvat3WEZFh6IhblU1GPSZIiPAeI27ALZ4yfoxzfHiji3HtczzYHTS-b3d3dj1iYmHSu/pub?gid=0&single=true&output=csv";

        let allAssignments = [];
        let completedAssignments = new Set();
        let showCompleted = false;

        document.addEventListener("DOMContentLoaded", () => {
            initTheme();
            loadCompletedFromStorage();
            fetchData();

            document.getElementById("search-input").addEventListener("input", filterData);
            document.getElementById("filter-class").addEventListener("change", filterData);
            document.getElementById("toggle-completed").addEventListener("click", toggleCompletedView);
        });

        /* ------------------ DARK MODE ------------------ */
        function initTheme() {
            const icon = document.getElementById("theme-icon");

            const saved = localStorage.getItem("theme") || "dark";
            document.documentElement.classList.toggle("dark", saved === "dark");

            icon.classList.add(saved === "dark" ? "fa-sun" : "fa-moon");

            document.getElementById("theme-toggle").onclick = () => {
                const isDark = document.documentElement.classList.toggle("dark");
                icon.classList.replace(isDark ? "fa-moon" : "fa-sun", isDark ? "fa-sun" : "fa-moon");
                localStorage.setItem("theme", isDark ? "dark" : "light");
            };
        }

        /* ------------------ COMPLETION STORAGE ------------------ */
        function loadCompletedFromStorage() {
            const stored = localStorage.getItem("completedAssignments");
            if (stored) {
                completedAssignments = new Set(JSON.parse(stored));
            }
        }

        function saveCompletedToStorage() {
            localStorage.setItem("completedAssignments", JSON.stringify([...completedAssignments]));
        }

        function toggleCompletion(assignmentId) {
            if (completedAssignments.has(assignmentId)) {
                completedAssignments.delete(assignmentId);
            } else {
                completedAssignments.add(assignmentId);
            }
            saveCompletedToStorage();
            filterData();
            renderStats();
        }

        function toggleCompletedView() {
            showCompleted = !showCompleted;
            const btn = document.getElementById("toggle-completed");
            btn.innerHTML = showCompleted ? 
                '<i class="fa-regular fa-eye-slash mr-1"></i> Hide Completed' : 
                '<i class="fa-regular fa-eye mr-1"></i> Show Completed';
            filterData();
        }

        /* ------------------ FETCH DATA ------------------ */
        async function fetchData() {
            try {
                const res = await fetch(SHEET_CSV_URL);
                const text = await res.text();

                allAssignments = parseCSV(text);
                populateClassFilter();
                renderStats();
                renderAssignments(allAssignments);

                document.getElementById("loader").classList.add("hidden");
                document.getElementById("assignment-container").classList.remove("hidden");

                document.getElementById("last-updated").textContent =
                    "Last synced: " + new Date().toLocaleTimeString();

            } catch (e) {
                document.getElementById("loader").innerHTML =
                    `<p class="text-red-500">Error loading data.</p>`;
            }
        }

        /* ------------------ PARSE CSV ------------------ */
        function parseCSV(text) {
            const lines = text.split(/\r?\n/);
            const result = [];
            let headerFound = false;

            lines.forEach((row, index) => {
                const cells = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
                                 .map(c => c.replace(/^"|"$/g, "").trim());

                if (!headerFound) {
                    if (cells[1]?.toUpperCase().includes("CLASS")) headerFound = true;
                    return;
                }

                if (!cells[1]) return;

                // Create a unique ID for each assignment
                const assignmentId = `${cells[1]}-${cells[2]}-${cells[5]}`.replace(/\s+/g, '-');

                result.push({
                    id: assignmentId,
                    className: cells[1],
                    title: cells[2] || "Untitled Assignment",
                    desc: cells[3] || "",
                    priority: cells[4] || "Low",
                    date: cells[5] || "",
                    daysLeft: parseInt(cells[6]) || 0
                });
            });

            return result;
        }

        /* ------------------ STATS ------------------ */
        function renderStats() {
            const activeAssignments = allAssignments.filter(a => !completedAssignments.has(a.id));
            const completedCount = allAssignments.filter(a => completedAssignments.has(a.id)).length;
            
            document.getElementById("stat-total").textContent = allAssignments.length;
            document.getElementById("stat-active").textContent = activeAssignments.length;
            document.getElementById("stat-completed").textContent = completedCount;
            
            // Upcoming: only count active assignments within 7 days
            document.getElementById("stat-upcoming").textContent =
                activeAssignments.filter(a => a.daysLeft <= 7 && a.daysLeft >= 0).length;
        }

        /* ------------------ CLASS FILTER ------------------ */
        function populateClassFilter() {
            const select = document.getElementById("filter-class");
            [...new Set(allAssignments.map(a => a.className))].sort().forEach(cls => {
                const opt = document.createElement("option");
                opt.value = opt.textContent = cls;
                select.appendChild(opt);
            });
        }

        /* ------------------ FILTER ------------------ */
        function filterData() {
            const q = document.getElementById("search-input").value.toLowerCase();
            const cls = document.getElementById("filter-class").value;

            let filtered = allAssignments.filter(item =>
                (item.title.toLowerCase().includes(q) ||
                 item.className.toLowerCase().includes(q)) &&
                (cls === "All" || item.className === cls)
            );

            // Sort by days left (ascending - soonest first)
            filtered.sort((a, b) => {
                // Handle overdue items first
                if (a.daysLeft < 0 && b.daysLeft >= 0) return -1;
                if (a.daysLeft >= 0 && b.daysLeft < 0) return 1;
                // Then sort by days left
                return a.daysLeft - b.daysLeft;
            });

            // Filter out completed items if not showing them
            if (!showCompleted) {
                filtered = filtered.filter(item => !completedAssignments.has(item.id));
            }

            renderAssignments(filtered);
        }

        /* ------------------ RENDER CARDS ------------------ */
        function renderAssignments(data) {
            const container = document.getElementById("assignment-container");
            container.innerHTML = "";

            if (data.length === 0) {
                document.getElementById("empty-state").classList.remove("hidden");
                return;
            }
            document.getElementById("empty-state").classList.add("hidden");

            // Separate completed and active assignments
            const active = [];
            const completed = [];

            data.forEach(item => {
                if (completedAssignments.has(item.id)) {
                    completed.push(item);
                } else {
                    active.push(item);
                }
            });

            // Render active assignments first
            active.forEach(item => {
                container.appendChild(createCard(item, false));
            });

            // Then render completed assignments at the bottom
            completed.forEach(item => {
                container.appendChild(createCard(item, true));
            });
        }

        /* ------------------ CREATE CARD ------------------ */
        function createCard(item, isCompleted) {
            const card = document.createElement("div");
            
            if (isCompleted) {
                card.className = "completed-card bg-white dark:bg-gray-800 p-5 rounded-lg shadow border border-gray-200 dark:border-gray-700 " +
                    "flex flex-col sm:flex-row justify-between sm:items-center gap-4 fade-in";
            } else {
                card.className = "bg-white dark:bg-gray-800 p-5 rounded-lg shadow border border-gray-200 dark:border-gray-700 " +
                    "flex flex-col sm:flex-row justify-between sm:items-center gap-4 fade-in";
            }

            let priorityClass = "bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200";
            if (item.priority.toLowerCase().includes("high"))
                priorityClass = "bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200";
            if (item.priority.toLowerCase().includes("medium"))
                priorityClass = "bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200";
            if (item.priority.toLowerCase().includes("low"))
                priorityClass = "bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200";

            let daysText = `${item.daysLeft} Days Left`;
            let daysColor = "text-gray-600 dark:text-gray-300";

            if (item.daysLeft < 0) {
                daysText = `Overdue by ${Math.abs(item.daysLeft)} Days`;
                daysColor = "text-red-600 dark:text-red-400 font-bold";
            } else if (item.daysLeft <= 3) {
                daysColor = "text-orange-600 dark:text-orange-400 font-bold";
            }

            // If completed, change the styling
            if (isCompleted) {
                daysText = "Completed";
                daysColor = "text-green-600 dark:text-green-400 font-bold";
                priorityClass = "bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400";
            }

            card.innerHTML = `
                <div class="flex items-start gap-4">
                    <!-- Checkbox -->
                    <div class="checkbox-wrapper mt-1">
                        <div class="custom-checkbox ${completedAssignments.has(item.id) ? 'checked' : ''}" 
                             data-id="${item.id}"></div>
                    </div>
                    
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="px-2.5 py-0.5 rounded-full text-xs font-medium
                                ${isCompleted ? 'bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400' : 'bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200'}">
                                ${item.className}
                            </span>

                            <span class="badge ${priorityClass}">${item.priority}</span>
                        </div>

                        <h4 class="text-lg font-semibold ${isCompleted ? 'line-through text-gray-500 dark:text-gray-400' : ''}">
                            ${item.title}
                        </h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 line-clamp-2 ${isCompleted ? 'opacity-70' : ''}">
                            ${item.desc}
                        </p>
                    </div>
                </div>

                <div class="flex items-center gap-6 sm:w-auto w-full justify-between sm:justify-end
                    border-t sm:border-t-0 pt-3 sm:pt-0 ml-10 sm:ml-0">

                    <div class="text-right">
                        <p class="text-xs text-gray-400 uppercase font-semibold">Due Date</p>
                        <p class="font-medium ${isCompleted ? 'line-through text-gray-500' : ''}">${item.date}</p>
                    </div>

                    <div class="text-right w-28">
                        <p class="text-xs uppercase font-semibold ${daysColor}">${daysText}</p>
                    </div>
                </div>
            `;
            
            // Add click event to checkbox
            const checkbox = card.querySelector('.custom-checkbox');
            checkbox.addEventListener('click', () => {
                toggleCompletion(item.id);
            });

            return card;
        }
    </script>

</body>
</html>
